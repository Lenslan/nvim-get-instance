# 实现计划: Verilog 层级导航器

## 概述

本实现计划将 Verilog 层级导航器设计转换为可执行的开发任务。插件将使用 Lua 实现，利用 Neovim 的 Tree-sitter 和 LSP API。任务按照从核心功能到高级特性的顺序组织，每个任务都包含具体的实现目标和需求引用。

## 任务

- [ ] 1. 设置项目结构和配置模块
  - 创建插件目录结构：`lua/verilog-hierarchy/`
  - 实现 `config.lua` 模块，包含默认配置和配置合并逻辑
  - 实现 `init.lua` 入口模块，提供 `setup()` 函数
  - _需求: 5.1, 5.2_

- [ ] 1.1 编写配置模块的属性测试
  - **属性 6: 配置合并正确性**
  - **验证需求: 5.2, 5.3, 5.4**

- [ ] 2. 实现 Tree-sitter 解析器模块
  - [ ] 2.1 创建 `parser.lua` 模块
    - 实现 `is_treesitter_available()` 函数检查 Tree-sitter 可用性
    - 实现 `parse_instantiations(bufnr)` 函数使用 Tree-sitter 查询提取例化信息
    - 处理简单例化和参数化例化
    - _需求: 1.1, 3.1, 3.2, 3.4_

  - [ ] 2.2 编写解析器的属性测试
    - **属性 1: 解析提取完整性**
    - **验证需求: 1.1, 3.2**

  - [ ] 2.3 编写参数化例化的属性测试
    - **属性 3: 参数化例化识别**
    - **验证需求: 3.4**

- [ ] 3. 创建 Tree-sitter 查询文件
  - 创建 `queries/verilog/instantiations.scm` 文件
  - 编写查询模式匹配模块例化节点
  - 支持简单例化和参数化例化的匹配
  - _需求: 3.1, 3.2_

- [ ] 4. 实现回退解析器
  - [ ] 4.1 在 `parser.lua` 中实现 `fallback_parse(bufnr)` 函数
    - 使用正则表达式匹配 Verilog 例化语法
    - 提取模块类型、实例名称和行号
    - _需求: 3.3_

  - [ ] 4.2 编写回退解析器的单元测试
    - 测试简单例化的正则匹配
    - 测试参数化例化的正则匹配
    - _需求: 3.3_

- [ ] 5. 检查点 - 确保解析功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 6. 实现 UI 模块
  - [ ] 6.1 创建 `ui.lua` 模块
    - 实现 `show_hierarchy(instantiations, on_select)` 函数创建浮动窗口
    - 实现列表项格式化逻辑（行号、模块类型、实例名称）
    - 实现 `close_window()` 函数关闭浮动窗口
    - _需求: 1.2, 1.3, 1.4_

  - [ ] 6.2 编写 UI 格式化的属性测试
    - **属性 2: 显示内容格式正确性**
    - **验证需求: 1.2, 1.3**

  - [ ] 6.3 实现键盘映射设置
    - 实现 `setup_keymaps(bufnr, on_select)` 函数
    - 设置 j/k 和方向键导航
    - 设置回车键选择
    - 设置 ESC 和 q 键关闭
    - _需求: 6.1, 6.2, 6.3_

  - [ ] 6.4 编写取消操作的属性测试
    - **属性 5: 取消操作保持状态**
    - **验证需求: 2.4, 6.3**

- [ ] 7. 实现导航模块
  - [ ] 7.1 创建 `navigator.lua` 模块
    - 实现 `jump_to_location(line, col)` 函数跳转到指定位置
    - 实现 `is_lsp_available()` 函数检查 LSP 状态
    - 实现 `jump_to_definition(module_type)` 函数使用 LSP 跳转
    - _需求: 2.1, 2.2, 2.3, 4.1, 4.2_

  - [ ] 7.2 编写跳转功能的属性测试
    - **属性 4: 跳转位置准确性**
    - **验证需求: 2.1, 2.2, 2.3, 6.2**

- [ ] 8. 实现错误处理
  - [ ] 8.1 在各模块中添加错误处理逻辑
    - Parser: 处理 Tree-sitter 不可用、语法错误、空文件
    - Navigator: 处理 LSP 超时、跳转失败
    - UI: 处理窗口创建失败、缓冲区操作失败
    - _需求: 1.5, 3.3, 4.2, 4.3, 7.1, 7.2, 7.3, 7.4_

  - [ ] 8.2 编写错误处理的属性测试
    - **属性 7: 错误消息提供性**
    - **验证需求: 7.1, 7.4**

- [ ] 9. 检查点 - 确保核心功能完整
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 10. 集成所有模块
  - [ ] 10.1 在 `init.lua` 中实现主要功能函数
    - 实现 `show_hierarchy()` 函数协调 parser 和 ui 模块
    - 实现 `jump_to_definition()` 函数使用 navigator 模块
    - 注册 Neovim 命令和快捷键
    - _需求: 1.1, 2.1, 5.1, 5.2_

  - [ ] 10.2 编写集成测试
    - 测试完整的显示层级工作流
    - 测试完整的跳转工作流
    - 测试配置自定义
    - _需求: 1.1, 2.1, 5.2_

- [ ] 11. 实现高级 UI 功能
  - [ ] 11.1 添加窗口样式配置
    - 支持浮动窗口和分屏模式切换
    - 支持自定义边框样式
    - 支持自定义窗口大小比例
    - _需求: 5.3_

  - [ ] 11.2 添加高亮和视觉反馈
    - 实现当前选中项的高亮显示
    - 设置初始焦点到第一个例化项
    - _需求: 6.4, 6.5_

- [ ] 12. 优化性能
  - 实现解析结果缓存
  - 对大文件使用异步解析
  - 限制显示的最大例化数量
  - _需求: 1.1_

- [ ] 13. 添加文档和示例
  - 编写 README.md 包含安装和使用说明
  - 编写 doc/verilog-hierarchy.txt Vim 帮助文档
  - 提供配置示例
  - _需求: 5.1, 5.2, 5.3, 5.4_

- [ ] 14. 最终检查点
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

- 每个任务都引用了具体的需求以确保可追溯性
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 所有测试任务都是必需的，以确保代码质量
